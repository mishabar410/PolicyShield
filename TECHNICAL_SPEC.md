# PolicyShield ‚Äî –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è

> **Version:** 0.2-refined  
> **Date:** 2026-02-11  
> **Status:** RFC / pre-implementation

---

## 1. –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ PolicyShield: —Ñ–æ—Ä–º–∞—Ç YAML DSL –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª, –∞–ª–≥–æ—Ä–∏—Ç–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è tool calls —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ (matcher), —Å–∏—Å—Ç–µ–º—É –≤–µ—Ä–¥–∏–∫—Ç–æ–≤ –∏ counterexample-–æ–≤, –º–µ—Ö–∞–Ω–∏–∑–º PII-–¥–µ—Ç–µ–∫—Ü–∏–∏, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ –∏ rate limiting, —Ñ–æ—Ä–º–∞—Ç –∞—É–¥–∏—Ç–Ω–æ–≥–æ –ª–æ–≥–∞ (trace), –∏ CLI-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å nanobot –æ–ø–∏—Å–∞–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ ‚Äî INTEGRATION_SPEC.md.

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                     ‚îÇ       PolicyShield Core       ‚îÇ
                     ‚îÇ                              ‚îÇ
  YAML files ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ ‚îÇ  RuleSet     Matcher          ‚îÇ
                     ‚îÇ  (–∑–∞–≥—Ä—É–∑–∫–∞)  (—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ)  ‚îÇ
                     ‚îÇ      ‚îÇ           ‚îÇ            ‚îÇ
                     ‚îÇ      ‚ñº           ‚ñº            ‚îÇ
                     ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
                     ‚îÇ  ‚îÇ   ShieldEngine    ‚îÇ        ‚îÇ
                     ‚îÇ  ‚îÇ   (orchestrator)  ‚îÇ        ‚îÇ
                     ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò        ‚îÇ
                     ‚îÇ      ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ            ‚îÇ
                     ‚îÇ      ‚ñº   ‚ñº   ‚ñº   ‚ñº            ‚îÇ
                     ‚îÇ  PII  Session Verdict Trace   ‚îÇ
                     ‚îÇ  Det. Manager Builder  Rec.   ‚îÇ
                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚ñº                 ‚ñº                 ‚ñº
     nanobot adapter   langchain adapter   (–±—É–¥—É—â–∏–µ)
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∏—Ö –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å |
|-----------|----------------|
| **RuleSet** | –ó–∞–≥—Ä—É–∑–∫–∞, –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ YAML-–ø—Ä–∞–≤–∏–ª. –ú–µ—Ä–∂ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤. –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ |
| **Matcher** | –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (tool_name, args, session_context) —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –∫–∞–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–º–µ–Ω–∏–º—ã |
| **PIIDetector** | Regex-based –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ PII –≤ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö (L0) |
| **SessionManager** | –•—Ä–∞–Ω–µ–Ω–∏–µ per-session —Å–æ—Å—Ç–æ—è–Ω–∏—è: —Å—á—ë—Ç—á–∏–∫–∏ tool calls (–¥–ª—è rate limit), –∫–µ—à approvals, taint labels |
| **VerdictBuilder** | –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Ä–¥–∏–∫—Ç–∞ (ALLOW/BLOCK/APPROVE/REDACT) —Å counterexample –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ |
| **TraceRecorder** | –ó–∞–ø–∏—Å—å –∫–∞–∂–¥–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –≤ JSONL-–ª–æ–≥ |
| **ShieldEngine** | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä: –ø—Ä–∏–Ω–∏–º–∞–µ—Ç (tool_name, args, session_id), –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ—Ä–¥–∏–∫—Ç |

---

## 3. YAML DSL ‚Äî —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞

### 3.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞

–ö–∞–∂–¥—ã–π YAML-—Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–¥–∏–Ω –Ω–∞–±–æ—Ä –ø—Ä–∞–≤–∏–ª (ruleset). PolicyShield –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ `.yaml` / `.yml` —Ñ–∞–π–ª—ã –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ –º–µ—Ä–∂–∏—Ç –∏—Ö –≤ –µ–¥–∏–Ω—ã–π RuleSet.

```
shield: <string>         # –ò–º—è –Ω–∞–±–æ—Ä–∞ –ø—Ä–∞–≤–∏–ª (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)
version: <integer>        # –í–µ—Ä—Å–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ (—Å–µ–π—á–∞—Å: 1)
description: <string>    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
rules: <list[Rule]>       # –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª
```

### 3.2 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª–∞ (Rule)

```
Rule:
  id: <string>               # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ñ–∞–π–ª–∞)
  description: <string>      # –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ counterexample)
  enabled: <bool>            # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, default: true
  priority: <integer>        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, default: 0. –í—ã—à–µ = –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ

  when:                       # –£—Å–ª–æ–≤–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
    tool: <ToolMatcher>       # –ö–∞–∫–æ–π tool (–∏–ª–∏ —Å–ø–∏—Å–æ–∫ tools)
    args_match: <ArgsMatcher> # –£—Å–ª–æ–≤–∏—è –Ω–∞ –∞—Ä–≥—É–º–µ–Ω—Ç—ã tool call
    session: <SessionMatcher> # –£—Å–ª–æ–≤–∏—è –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏
    sender: <SenderMatcher>   # –£—Å–ª–æ–≤–∏—è –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–∫–∞–Ω–∞–ª, ID, —Ä–æ–ª—å)
    time: <TimeMatcher>       # –£—Å–ª–æ–≤–∏—è –Ω–∞ –≤—Ä–µ–º—è (—á–∞—Å—ã, –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏)

  then: <Verdict>             # –î–µ–π—Å—Ç–≤–∏–µ: allow | block | approve | redact
  
  message: <string>          # –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–≥–µ–Ω—Ç–∞ –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏
  suggestion: <string>       # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é (–¥–ª—è counterexample)
  alternatives: <list[str]>  # –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö tools
  severity: <string>         # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: low | medium | high | critical
  tags: <list[string]>       # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏
```

### 3.3 ToolMatcher ‚Äî —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ tool

–ü–æ–ª–µ `when.tool` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫ –∫–∞–∫–∏–º tools –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª–æ.

| –§–æ—Ä–º–∞—Ç | –°–µ–º–∞–Ω—Ç–∏–∫–∞ | –ü—Ä–∏–º–µ—Ä |
|--------|-----------|--------|
| –°—Ç—Ä–æ–∫–∞ | Exact match –ø–æ –∏–º–µ–Ω–∏ tool | `tool: exec` |
| –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ | Match –ª—é–±–æ–≥–æ –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö | `tool: [web_fetch, web_search]` |
| Wildcard `*` | Match –≤—Å–µ—Ö tools | `tool: "*"` |
| Glob-pattern | Glob matching | `tool: "web_*"` |

–ò–º–µ–Ω–∞ tools –±–µ—Ä—É—Ç—Å—è –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∞–≥–µ–Ω—Ç–Ω–æ–≥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞. –î–ª—è nanobot —ç—Ç–æ: `exec`, `read_file`, `write_file`, `edit_file`, `list_dir`, `web_search`, `web_fetch`, `message`, `spawn`, `cron`.

### 3.4 ArgsMatcher ‚Äî —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º

–ü–æ–ª–µ `when.args_match` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã tool call. –≠—Ç–æ —Å–ª–æ–≤–∞—Ä—å, –≥–¥–µ –∫–ª—é—á–∏ ‚Äî –∏–º–µ–Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ tool, –∞ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî —É—Å–ª–æ–≤–∏—è.

**–£—Å–ª–æ–≤–∏—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø–æ–ª–µ:**

| –£—Å–ª–æ–≤–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|--------|
| `regex: <pattern>` | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç regex | `command: { regex: "rm\\s+-rf" }` |
| `contains: <substring>` | –ü–æ–ª–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥—Å—Ç—Ä–æ–∫—É | `url: { contains: "internal.corp" }` |
| `starts_with: <prefix>` | –ü–æ–ª–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å | `path: { starts_with: "/etc/" }` |
| `not_starts_with: <prefix>` | –ü–æ–ª–µ –ù–ï –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å | `path: { not_starts_with: "{{workspace}}" }` |
| `equals: <value>` | –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ | `format: { equals: "json" }` |
| `in: <list>` | –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ | `language: { in: [python, javascript] }` |
| `not_in: <list>` | –ó–Ω–∞—á–µ–Ω–∏–µ –ù–ï –∏–∑ —Å–ø–∏—Å–∫–∞ | `mode: { not_in: [delete, truncate] }` |

**–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ `any_field`:**

–ü—Ä–∏–º–µ–Ω—è–µ—Ç —É—Å–ª–æ–≤–∏–µ –∫–æ **–≤—Å–µ–º** —Å—Ç—Ä–æ–∫–æ–≤—ã–º –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º tool call. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è PII-–¥–µ—Ç–µ–∫—Ü–∏–∏:

```
args_match:
  any_field: { contains_pattern: "pii" }
```

–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ `contains_pattern: "pii"` ‚Äî —ç—Ç–æ –Ω–µ regex, –∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è PIIDetector: –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º PII-–¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–º (L0 regex).

**–®–∞–±–ª–æ–Ω—ã (template variables):**

–í –∑–Ω–∞—á–µ–Ω–∏—è—Ö —É—Å–ª–æ–≤–∏–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
- `{{workspace}}` ‚Äî —Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∞–≥–µ–Ω—Ç–∞
- `{{home}}` ‚Äî –¥–æ–º–∞—à–Ω—è—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `{{session_id}}` ‚Äî ID —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
- `{{sender_id}}` ‚Äî ID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
- `{{channel}}` ‚Äî –∫–∞–Ω–∞–ª (telegram, discord, cli, ...)

### 3.5 SessionMatcher ‚Äî —É—Å–ª–æ–≤–∏—è –Ω–∞ —Å–µ—Å—Å–∏—é

–ü–æ–ª–µ `when.session` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏.

| –£—Å–ª–æ–≤–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|--------|
| `tool_count: { gt: N }` | –û–±—â–µ–µ —á–∏—Å–ª–æ tool calls –≤ —Å–µ—Å—Å–∏–∏ > N | `tool_count: { gt: 50 }` |
| `tool_count.<name>: { gt: N }` | –ß–∏—Å–ª–æ –≤—ã–∑–æ–≤–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ tool > N | `tool_count.web_fetch: { gt: 10 }` |
| `has_taint: <list>` | –°–µ—Å—Å–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–µ taint labels | `has_taint: [PII_DIRECT]` |
| `duration_minutes: { gt: N }` | –°–µ—Å—Å–∏—è –¥–ª–∏—Ç—Å—è –¥–æ–ª—å—à–µ N –º–∏–Ω—É—Ç | `duration_minutes: { gt: 60 }` |

### 3.6 SenderMatcher ‚Äî —É—Å–ª–æ–≤–∏—è –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è

```
sender:
  id: <string | list[string]>       # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  not_id: <string | list[string]>   # –ò—Å–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  channel: <string | list[string]>  # –ö–∞–Ω–∞–ª (telegram, discord, cli)
  role: <string | list[string]>     # –†–æ–ª—å (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω RBAC)
```

–≠—Ç–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `allowFrom` –≤ nanobot, –ø–æ–∑–≤–æ–ª—è—è per-rule –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–º–µ—Å—Ç–æ per-channel.

### 3.7 TimeMatcher ‚Äî –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è

```
time:
  hours: { between: [9, 18] }       # –¢–æ–ª—å–∫–æ –≤ —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã
  days: { in: [mon, tue, wed, thu, fri] }  # –¢–æ–ª—å–∫–æ –≤ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏
  timezone: "Europe/Moscow"
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –¥–µ—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è.

### 3.8 Verdict ‚Äî –¥–µ–π—Å—Ç–≤–∏–µ

–ü–æ–ª–µ `then` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –¥–µ–ª–∞–µ—Ç shield –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª–∞.

| –í–µ—Ä–¥–∏–∫—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `allow` | –Ø–≤–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å (override –±–æ–ª–µ–µ –æ–±—â–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —á–µ—Ä–µ–∑ priority) |
| `block` | –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å tool call, –≤–µ—Ä–Ω—É—Ç—å counterexample –∞–≥–µ–Ω—Ç—É |
| `approve` | –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ, –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É —á–µ–ª–æ–≤–µ–∫–∞ |
| `redact` | –†–∞–∑—Ä–µ—à–∏—Ç—å, –Ω–æ –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å PII/—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ |

–ü—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–≤–ø–∞–≤—à–∏—Ö –ø—Ä–∞–≤–∏–ª–∞—Ö –ø–æ–±–µ–∂–¥–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–æ —Å –Ω–∞–∏–≤—ã—Å—à–∏–º `priority`. –ü—Ä–∏ —Ä–∞–≤–Ω–æ–º priority –¥–µ–π—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø "deny wins" ‚Äî `block` > `approve` > `redact` > `allow`.

### 3.9 –ü–æ—Ä—è–¥–æ–∫ –æ—Ü–µ–Ω–∫–∏ –ø—Ä–∞–≤–∏–ª

```
1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ RuleSet
2. –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ enabled: true
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞:
   a. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å when.tool ‚Üí —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —Å —Ç–µ–∫—É—â–∏–º tool?
   b. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å when.args_match ‚Üí —Å–æ–≤–ø–∞–¥–∞—é—Ç –ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã?
   c. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å when.session ‚Üí —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏?
   d. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å when.sender ‚Üí —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å?
   e. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å when.time ‚Üí —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è?
   f. –ï—Å–ª–∏ –í–°–ï —É—Å–ª–æ–≤–∏—è —Å–æ–≤–ø–∞–ª–∏ ‚Üí –ø—Ä–∞–≤–∏–ª–æ –∞–∫—Ç–∏–≤–Ω–æ
4. –ò–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª –≤—ã–±—Ä–∞—Ç—å —Å –Ω–∞–∏–≤—ã—Å—à–∏–º priority
5. –ü—Ä–∏ —Ä–∞–≤–Ω–æ–º priority: block > approve > redact > allow
6. –í–µ—Ä–Ω—É—Ç—å –≤–µ—Ä–¥–∏–∫—Ç + –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ä–∞–±–æ—Ç–∞–≤—à–µ–º –ø—Ä–∞–≤–∏–ª–µ
```

### 3.10 –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ø—Ä–∞–≤–∏–ª

```
shield: corporate-security
version: 1
description: "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è AI-–∞–≥–µ–Ω—Ç–æ–≤"

rules:
  # --- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ ---

  - id: no-destructive-shell
    description: "–ó–∞–ø—Ä–µ—Ç –¥–µ—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã—Ö shell-–∫–æ–º–∞–Ω–¥"
    when:
      tool: exec
      args_match:
        command: { regex: "rm\\s+-r|rmdir|mkfs|dd\\s+if=|format\\s+|fdisk" }
    then: block
    message: "Destructive shell commands are forbidden."
    severity: critical

  - id: no-pii-external
    description: "–ó–∞–ø—Ä–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ PII –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã"
    when:
      tool: [web_fetch, web_search]
      args_match:
        any_field: { contains_pattern: "pii" }
    then: block
    message: "PII detected in arguments to external service."
    suggestion: "Redact PII before making external requests."
    severity: high
    tags: [privacy, gdpr]

  - id: workspace-only-writes
    description: "–ó–∞–ø–∏—Å—å —Ñ–∞–π–ª–æ–≤ —Ç–æ–ª—å–∫–æ –≤ workspace"
    when:
      tool: [write_file, edit_file]
      args_match:
        path: { not_starts_with: "{{workspace}}" }
    then: block
    message: "File writes are restricted to the workspace directory."

  # --- Approvals ---

  - id: approve-network-commands
    description: "–°–µ—Ç–µ–≤—ã–µ shell-–∫–æ–º–∞–Ω–¥—ã —Ç—Ä–µ–±—É—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
    when:
      tool: exec
      args_match:
        command: { regex: "curl|wget|ssh|scp|rsync|nc|netcat" }
    then: approve
    message: "Network command requires human approval."
    severity: medium

  # --- Rate Limits ---

  - id: web-request-limit
    description: "–ú–∞–∫—Å–∏–º—É–º 20 web-–∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Å–µ—Å—Å–∏—é"
    when:
      tool: [web_fetch, web_search]
      session:
        tool_count.web_fetch: { gt: 20 }
    then: block
    message: "Web request limit (20/session) exceeded."

  # --- –Ø–≤–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è ---

  - id: allow-internal-api
    description: "–†–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ internal API"
    priority: 10
    when:
      tool: web_fetch
      args_match:
        url: { contains: ".internal.corp" }
    then: allow
```

---

## 4. Matcher Engine

### 4.1 –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

Matcher –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞ –≤—Ö–æ–¥:
- `tool_name` (—Å—Ç—Ä–æ–∫–∞) ‚Äî –∏–º—è –≤—ã–∑—ã–≤–∞–µ–º–æ–≥–æ tool
- `args` (—Å–ª–æ–≤–∞—Ä—å) ‚Äî –∞—Ä–≥—É–º–µ–Ω—Ç—ã tool call
- `session_context` ‚Äî —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (—Å—á—ë—Ç—á–∏–∫–∏, taints, –≤—Ä–µ–º—è, –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å)

–ò –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
- `matched_rules` ‚Äî —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª, —É—Å–ª–æ–≤–∏—è –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–π –ø–æ priority

### 4.2 –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∏–Ω–¥–µ–∫—Å –ø–æ tool name

–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∞–≤–∏–ª —Å—Ç—Ä–æ–∏—Ç—Å—è –∏–Ω–¥–µ–∫—Å:

```
tool_index: dict[str, list[Rule]]
  "exec" ‚Üí [rule1, rule3, rule7]
  "web_fetch" ‚Üí [rule2, rule4, rule5]
  "*" ‚Üí [rule9]  # wildcard –ø—Ä–∞–≤–∏–ª–∞
```

–ü—Ä–∏ tool call "exec" –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ `tool_index["exec"]` + `tool_index["*"]`. –≠—Ç–æ O(k) –≤–º–µ—Å—Ç–æ O(n), –≥–¥–µ k ‚Äî —á–∏—Å–ª–æ –ø—Ä–∞–≤–∏–ª –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ tool, n ‚Äî –æ–±—â–µ–µ —á–∏—Å–ª–æ –ø—Ä–∞–≤–∏–ª.

### 4.3 Pattern matching –¥–ª—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤

–ö–∞–∂–¥–æ–µ —É—Å–ª–æ–≤–∏–µ –≤ `args_match` –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –≤ –ø—Ä–µ–¥–∏–∫–∞—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:

| –£—Å–ª–æ–≤–∏–µ | –ö–æ–º–ø–∏–ª—è—Ü–∏—è |
|---------|-----------|
| `regex: "pattern"` | `re.compile("pattern")` ‚Äî —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π regex |
| `contains: "substr"` | `lambda v: "substr" in str(v)` |
| `starts_with: "prefix"` | `lambda v: str(v).startswith("prefix")` |
| `contains_pattern: "pii"` | –°—Å—ã–ª–∫–∞ –Ω–∞ PIIDetector |
| `in: [a, b, c]` | `lambda v: v in {"a", "b", "c"}` (set –¥–ª—è O(1)) |

–ü—Ä–µ–¥–∏–∫–∞—Ç—ã –∫–µ—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ –≤–µ—Å—å lifetime RuleSet.

### 4.4 Template resolution

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `{{workspace}}`, `{{home}}` –∏ —Ç.–¥. —Ä–∞–∑—Ä–µ—à–∞—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∞–≤–∏–ª. `{{session_id}}`, `{{sender_id}}`, `{{channel}}` ‚Äî –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ matcher (–æ–Ω–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞).

---

## 5. PII Detector (L0)

### 5.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

PIIDetector —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ L0 ‚Äî —Ç–æ–ª—å–∫–æ regex, –±–µ–∑ NER –∏–ª–∏ LLM. –≠—Ç–æ —Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:
- L0 regex: < 1 –º—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É, zero dependencies, –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
- L1 NER (spaCy): ~10-50 –º—Å, dependency –Ω–∞ –º–æ–¥–µ–ª—å, probabilistic
- L2 LLM: ~500 –º—Å+, –¥–æ—Ä–æ–≥–æ, non-deterministic

–î–ª—è v0.x L0 –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω. L1/L2 –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞–∫ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ `detection_level` –≤ –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö.

### 5.2 –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

| –¢–∏–ø PII | –ü—Ä–∏–º–µ—Ä | –ú–µ—Ç–æ–¥ |
|---------|--------|-------|
| Email | `john@example.com` | Regex: RFC 5322 —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π |
| –¢–µ–ª–µ—Ñ–æ–Ω | `+7 (999) 123-45-67` | Regex: –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã |
| –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ | `4111 1111 1111 1111` | Regex + Luhn checksum |
| SSN (US) | `123-45-6789` | Regex: `\d{3}-\d{2}-\d{4}` |
| IBAN | `DE89 3704 0044 0532 0130 00` | Regex: `[A-Z]{2}\d{2}[\s]?[\dA-Z]{4,}` |
| –ü–∞—Å–ø–æ—Ä—Ç –†–§ | `45 09 123456` | Regex: `\d{2}\s?\d{2}\s?\d{6}` |
| –ò–ù–ù | `1234567890` | Regex + –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ü–∏—Ñ—Ä–∞ |

### 5.3 –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

–í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PolicyShield –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ regex-–ø–∞—Ç—Ç–µ—Ä–Ω—ã:

```
pii:
  custom_patterns:
    employee_id: "EMP-\\d{6}"
    internal_project: "PROJ-[A-Z]{3}-\\d{4}"
```

### 5.4 Taint Labels

–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ PII, —Å–µ—Å—Å–∏—è –ø–æ–ª—É—á–∞–µ—Ç taint label:

| Label | –ß—Ç–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ |
|-------|---------------|
| `PII_DIRECT` | Email, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º—è |
| `PII_FINANCIAL` | –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞, IBAN, —Å—á—ë—Ç |
| `PII_GOVERNMENT` | SSN, –ò–ù–ù, –ø–∞—Å–ø–æ—Ä—Ç |
| `PII_CUSTOM` | –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã |

Taint labels —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ SessionManager –∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö —á–µ—Ä–µ–∑ `when.session.has_taint`.

### 5.5 Redaction

–ü—Ä–∏ –≤–µ—Ä–¥–∏–∫—Ç–µ `REDACT` PIIDetector –º–∞—Å–∫–∏—Ä—É–µ—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

```
–í—Ö–æ–¥:  "–°–≤—è–∂–∏—Ç–µ—Å—å —Å john@example.com, –∫–∞—Ä—Ç–∞ 4111 1111 1111 1111"
–í—ã—Ö–æ–¥: "–°–≤—è–∂–∏—Ç–µ—Å—å —Å [EMAIL_REDACTED], –∫–∞—Ä—Ç–∞ [CC_REDACTED]"
```

–ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:
- **Pre-call:** –∫ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º tool call (–µ—Å–ª–∏ –≤–µ—Ä–¥–∏–∫—Ç = REDACT)
- **Post-call:** –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É tool call (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ post-call PII –ø—Ä–æ–≤–µ—Ä–∫–∞)

---

## 6. –°–∏—Å—Ç–µ–º–∞ –≤–µ—Ä–¥–∏–∫—Ç–æ–≤ –∏ Counterexample

### 6.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–µ—Ä–¥–∏–∫—Ç–∞

–ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ ShieldEngine –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç Verdict:

```
Verdict:
  decision: ALLOW | BLOCK | APPROVE | REDACT
  rule_id: <string | null>       # ID —Å—Ä–∞–±–æ—Ç–∞–≤—à–µ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ (null –µ—Å–ª–∏ ALLOW –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  rule_description: <string>     # –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
  message: <string>              # –°–æ–æ–±—â–µ–Ω–∏–µ (–∏–∑ –ø—Ä–∞–≤–∏–ª–∞)
  suggestion: <string | null>    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é
  alternatives: <list[str]>      # –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ tools
  severity: <string>             # low | medium | high | critical
  pii_detected: <list[str]>      # –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã PII
  tags: <list[str]>              # –¢–µ–≥–∏ –ø—Ä–∞–≤–∏–ª–∞
  timestamp: <datetime>          # –í—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è
  latency_ms: <float>            # –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –º—Å
```

### 6.2 Counterexample (repair loop)

–ü—Ä–∏ `decision: BLOCK` shield —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç **counterexample** ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∞–≥–µ–Ω—Ç—É –∫–∞–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç tool call. –§–æ—Ä–º–∞—Ç:

```
üõ°Ô∏è BLOCKED by PolicyShield
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Rule:        no-pii-external
Description: –ó–∞–ø—Ä–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ PII –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
Severity:    high
Tags:        privacy, gdpr
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Tool:        web_fetch
Field:       url
Detected:    PII_DIRECT (email pattern)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Suggestion:  Redact PII before making external requests
Alternatives: read_file, exec (for internal APIs)
```

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

LLM –≤–∏–¥–∏—Ç —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –∫–∞–∫ tool result. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ LLM (GPT-4, Claude, Gemini) —Å–ø–æ—Å–æ–±–Ω—ã:
1. –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å, —á—Ç–æ tool call –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
2. –ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é
3. –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å (—É–±—Ä–∞—Ç—å PII, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π tool)
4. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞

–≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç **repair loop** ‚Äî —Ü–∏–∫–ª "–ø–æ–ø—ã—Ç–∫–∞ ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ‚Üí –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞", –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –µ–≥–æ —É—á–∞—Å—Ç–∏—è.

### 6.3 –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä–¥–∏–∫—Ç–∞—Ö

| –í–µ—Ä–¥–∏–∫—Ç | –ß—Ç–æ –≤–∏–¥–∏—Ç –∞–≥–µ–Ω—Ç | –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Å–∏—Å—Ç–µ–º–µ |
|---------|----------------|--------------------------|
| `ALLOW` | –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç tool call | Tool call –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è, –∑–∞–ø–∏—Å—å –≤ trace |
| `BLOCK` | Counterexample (—Ç–µ–∫—Å—Ç) | Tool call **–Ω–µ** –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è, counterexample –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–∫ tool result |
| `APPROVE` | (–æ–∂–∏–¥–∞–Ω–∏–µ) ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ counterexample | Tool call –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –∑–∞–ø—Ä–æ—Å –Ω–∞ approve –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª |
| `REDACT` | –†–µ–∑—É–ª—å—Ç–∞—Ç —Å –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ | Tool call –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è, PII –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö –∏/–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è |

### 6.4 –í–µ—Ä–¥–∏–∫—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

–ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –Ω–µ —Å–æ–≤–ø–∞–ª–æ ‚Äî –≤–µ—Ä–¥–∏–∫—Ç **ALLOW** (open policy, default-permit). –≠—Ç–æ —Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ PolicyShield –±–µ–∑ –ø—Ä–∞–≤–∏–ª –Ω–µ –º–µ–Ω—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞.

–î–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å—Ä–µ–¥ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å catch-all –ø—Ä–∞–≤–∏–ª–æ:

```
- id: deny-all
  description: "–ó–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—Å—ë, —á—Ç–æ —è–≤–Ω–æ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ"
  priority: -1000
  when:
    tool: "*"
  then: block
```

---

## 7. Session Manager

### 7.1 –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–µ—Å—Å–∏—è

–°–µ—Å—Å–∏—è ‚Äî –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–æ–ª—è—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è PolicyShield. –û–Ω–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ `session_key` –∏–∑ –∞–≥–µ–Ω—Ç–Ω–æ–≥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞. –í nanobot —ç—Ç–æ `{channel}:{chat_id}` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `telegram:12345`).

### 7.2 –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏

```
SessionState:
  session_id: <string>
  started_at: <datetime>
  
  # –°—á—ë—Ç—á–∏–∫–∏ tool calls
  tool_counts: dict[str, int]        # {"exec": 5, "web_fetch": 3, ...}
  total_tool_count: int               # 8
  
  # Taint labels
  taints: set[TaintLabel]            # {PII_DIRECT, PII_FINANCIAL}
  
  # –ö–µ—à approvals (batch approve)
  approved_patterns: list[ApprovalPattern]
  
  # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  sender_id: <string>
  channel: <string>
```

### 7.3 Lifecycle —Å–µ—Å—Å–∏–∏

```
1. –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º tool call —Å –¥–∞–Ω–Ω—ã–º session_key
2. –°—á—ë—Ç—á–∏–∫–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º tool call
3. Taints –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ PII (–≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö)
4. Approvals –∫–µ—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Å—Å–∏–∏
5. –°–µ—Å—Å–∏—è —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ (–∏–ª–∏ –ø–æ —Ç–∞–π–º–∞—É—Ç—É)
```

### 7.4 Approval Cache (batch approve)

–ö–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –æ–¥–æ–±—Ä—è–µ—Ç tool call —Å –≤–µ—Ä–¥–∏–∫—Ç–æ–º APPROVE, PolicyShield –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç **–ø–∞—Ç—Ç–µ—Ä–Ω** –æ–¥–æ–±—Ä–µ–Ω–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞:

```
ApprovalPattern:
  tool: "exec"
  args_pattern: { command: regex("curl.*internal\\.api") }
  approved_by: "@admin"
  approved_at: <datetime>
  valid_until: <datetime>    # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ approval
```

–ü–æ—Å–ª–µ–¥—É—é—â–∏–µ tool calls, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—É, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç ALLOW –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É "3 approval-–∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å".

–û–±–ª–∞—Å—Ç—å –∫–µ—à–∞ ‚Äî —Å–µ—Å—Å–∏—è. –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è = —á–∏—Å—Ç—ã–π –∫–µ—à.

---

## 8. ShieldEngine ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä

### 8.1 Pre-call flow

```
–í—Ö–æ–¥: (tool_name, args, session_id)

1. –ü–æ–ª—É—á–∏—Ç—å SessionState –¥–ª—è session_id
   ‚Üí –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é

2. PII Detection
   ‚Üí –ü—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ args —á–µ—Ä–µ–∑ PIIDetector
   ‚Üí –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω PII ‚Äî –¥–æ–±–∞–≤–∏—Ç—å taint labels –≤ session
   ‚Üí –ó–∞–ø–æ–º–Ω–∏—Ç—å found_pii –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ matching

3. Rule Matching
   ‚Üí –ü–æ–ª—É—á–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç-–ø—Ä–∞–≤–∏–ª–∞ –∏–∑ tool_index[tool_name] + tool_index["*"]
   ‚Üí –î–ª—è –∫–∞–∂–¥–æ–≥–æ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å args_match, session, sender, time
   ‚Üí –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–æ–≤–ø–∞–≤—à–∏–µ
   ‚Üí –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ priority (desc), –∑–∞—Ç–µ–º –ø–æ severity (block > approve > redact > allow)

4. Approval Cache Check
   ‚Üí –ï—Å–ª–∏ –≤–µ—Ä–¥–∏–∫—Ç = APPROVE, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å approved_patterns
   ‚Üí –ï—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–∞–π–¥–µ–Ω –∏ –Ω–µ –∏—Å—Ç—ë–∫ ‚Äî override –Ω–∞ ALLOW

5. Build Verdict
   ‚Üí –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å Verdict object
   ‚Üí –ï—Å–ª–∏ BLOCK ‚Äî —Å–æ–±—Ä–∞—Ç—å counterexample

6. Session Update
   ‚Üí –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å tool_counts
   ‚Üí –û–±–Ω–æ–≤–∏—Ç—å taints

7. Trace Record
   ‚Üí –ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ TraceRecorder

–í—ã—Ö–æ–¥: Verdict
```

### 8.2 Post-call flow

```
–í—Ö–æ–¥: (tool_name, result, session_id)

1. PII Detection –Ω–∞ result
   ‚Üí –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω PII –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ tool call

2. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω:
   ‚Üí –î–æ–±–∞–≤–∏—Ç—å taints –≤ session
   ‚Üí –ï—Å–ª–∏ post-call redaction –≤–∫–ª—é—á—ë–Ω ‚Äî –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å PII –≤ result
   ‚Üí –ó–∞–ø–∏—Å—å –≤ trace

–í—ã—Ö–æ–¥: result (–≤–æ–∑–º–æ–∂–Ω–æ, —Å –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
```

### 8.3 –ì–∞—Ä–∞–Ω—Ç–∏–∏ latency

| –û–ø–µ—Ä–∞—Ü–∏—è | –¶–µ–ª–µ–≤–∞—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å | –ö–∞–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è |
|----------|--------------------|--------------------|
| PII Detection (L0) | < 1 –º—Å | –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ regex, —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –ø–æ–ª—è |
| Rule Matching | < 1 –º—Å | –ò–Ω–¥–µ–∫—Å –ø–æ tool name, —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–∏–∫–∞—Ç—ã |
| Session Lookup | < 0.1 –º—Å | In-memory dict |
| Trace Write | < 0.5 –º—Å | Async append to JSONL file |
| **–ò—Ç–æ–≥–æ pre-call** | **< 3 –º—Å** | |

–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: –æ–¥–∏–Ω LLM call –∑–∞–Ω–∏–º–∞–µ—Ç 500-5000 –º—Å. Overhead PolicyShield ‚Äî –º–µ–Ω–µ–µ 0.5% –æ—Ç –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

---

## 9. –§–æ—Ä–º–∞—Ç –∞—É–¥–∏—Ç–Ω–æ–≥–æ –ª–æ–≥–∞ (Trace)

### 9.1 –§–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–∏

–ö–∞–∂–¥–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –æ–¥–Ω–∞ JSON-—Å—Ç—Ä–æ–∫–∞ –≤ JSONL-—Ñ–∞–π–ª:

```
TraceEntry:
  timestamp: <ISO 8601>              # "2026-02-11T00:30:15.123Z"
  session_id: <string>               # "telegram:12345"
  event_type: <string>               # "pre_call" | "post_call" | "approval_request" | "approval_response"
  
  tool_name: <string>                # "web_fetch"
  args_hash: <string>                # SHA256(canonical_json(args)) ‚Äî –¥–ª—è privacy
  args_summary: <string | null>      # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ args
  
  verdict: <string>                  # "ALLOW" | "BLOCK" | "APPROVE" | "REDACT"
  rule_id: <string | null>           # "no-pii-external"
  rule_description: <string | null>  # "–ó–∞–ø—Ä–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ PII –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã"
  severity: <string | null>          # "high"
  tags: <list[string]>               # ["privacy", "gdpr"]
  
  pii_detected: <list[string]>       # ["PII_DIRECT", "PII_FINANCIAL"]
  
  approval_status: <string | null>   # "pending" | "approved" | "denied" | "timeout"
  approved_by: <string | null>       # "@admin"
  
  latency_ms: <float>                # 2.3
  
  metadata: <dict | null>            # –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

### 9.2 Privacy –≤ trace

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é args –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ **hash** (`args_hash`), –∞ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É—Ç–µ—á–∫—É PII –≤ –∞—É–¥–∏—Ç–Ω—ã–π –ª–æ–≥. –ü–æ–ª–Ω–∞—è –∑–∞–ø–∏—Å—å args –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (`trace.include_args: true`) –¥–ª—è debug-—Å—Ä–µ–¥.

### 9.3 –•—Ä–∞–Ω–µ–Ω–∏–µ

JSONL-—Ñ–∞–π–ª—ã —Ä–∞–∑–¥–µ–ª—è—é—Ç—Å—è –ø–æ –¥–Ω—è–º: `trace-2026-02-11.jsonl`, `trace-2026-02-12.jsonl`. –†–æ—Ç–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (retention period, max size).

### 9.4 Trace CLI

–£—Ç–∏–ª–∏—Ç–∞ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å trace:

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `policyshield trace show --session <id>` | –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏ |
| `policyshield trace show --last 1h` | –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å |
| `policyshield trace stats --period 7d` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π: –≤–µ—Ä–¥–∏–∫—Ç—ã, rules, tools |
| `policyshield trace violations` | –¢–æ–ª—å–∫–æ BLOCK –∏ APPROVE —Å–æ–±—ã—Ç–∏—è |
| `policyshield trace violations --rule <id>` | –ù–∞—Ä—É—à–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ |
| `policyshield trace export --format csv` | –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –≤–Ω–µ—à–Ω–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ |

---

## 10. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PolicyShield

### 10.1 –†–∞–∑–º–µ—â–µ–Ω–∏–µ

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):
1. –ê—Ä–≥—É–º–µ–Ω—Ç—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ShieldEngine (–ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π API)
2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `POLICYSHIELD_*`
3. –§–∞–π–ª `policyshield.yaml` –≤ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
4. –°–µ–∫—Ü–∏—è `shield` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–Ω–æ–≥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ (–¥–ª—è nanobot: –≤ `~/.nanobot/config.json`)

### 10.2 –ü–æ–ª–Ω–∞—è –º–æ–¥–µ–ª—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```
ShieldConfig:
  enabled: bool = false                     # –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å PolicyShield —Ü–µ–ª–∏–∫–æ–º
  
  mode: "enforce" | "monitor" | "dry-run"   # –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
    # enforce  ‚Äî –≤–µ—Ä–¥–∏–∫—Ç—ã –∏—Å–ø–æ–ª–Ω—è—é—Ç—Å—è (BLOCK —Ä–µ–∞–ª—å–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
    # monitor  ‚Äî –≤–µ—Ä–¥–∏–∫—Ç—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ tool calls –ø—Ä–æ—Ö–æ–¥—è—Ç
    # dry-run  ‚Äî —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –±–µ–∑ side effects (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª)
  
  rules_path: string                        # –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å YAML-–ø—Ä–∞–≤–∏–ª–∞–º–∏
  
  pii:
    enabled: bool = true                    # PII-–¥–µ—Ç–µ–∫—Ü–∏—è
    patterns: list[string] = ["email", "phone", "credit_card", "ssn"]
      # –ö–∞–∫–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤–∫–ª—é—á–∏—Ç—å
    custom_patterns: dict[str, str] = {}    # –ö–∞—Å—Ç–æ–º–Ω—ã–µ: name ‚Üí regex
    post_call_scan: bool = true             # –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã tool calls
    redact_format: string = "[{TYPE}_REDACTED]"
      # –§–æ—Ä–º–∞—Ç –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏: "{TYPE}" –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ —Ç–∏–ø PII
  
  approval:
    enabled: bool = false                   # Approval flow
    channel: string                         # –ß–µ—Ä–µ–∑ –∫–∞–∫–æ–π –∫–∞–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã
    admin_ids: list[string] = []            # –ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å
    timeout_seconds: int = 300              # –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
    default_on_timeout: "block" | "allow" = "block"
    cache_ttl_seconds: int = 3600           # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ approval –≤ –∫–µ—à–µ
  
  trace:
    enabled: bool = true                    # –ó–∞–ø–∏—Å—å –∞—É–¥–∏—Ç–Ω–æ–≥–æ –ª–æ–≥–∞
    path: string = "./shield_traces/"       # –ö—É–¥–∞ –ø–∏—Å–∞—Ç—å
    include_args: bool = false              # –ü–æ–ª–Ω—ã–µ args –≤–º–µ—Å—Ç–æ hash
    retention_days: int = 90                # –•—Ä–∞–Ω–∏—Ç—å N –¥–Ω–µ–π
    max_file_size_mb: int = 100             # –†–æ—Ç–∞—Ü–∏—è –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
  
  session:
    timeout_minutes: int = 60              # –¢–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏
    max_tool_calls: int = 1000             # Hard limit –Ω–∞ –∫–æ–ª-–≤–æ tool calls
  
  counterexample:
    format: "plain" | "structured" = "structured"
      # plain ‚Äî —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
      # structured ‚Äî —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ –∏ –ø–æ–ª—è–º–∏
    include_alternatives: bool = true       # –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ tools
    include_suggestion: bool = true         # –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
```

### 10.3 –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

| –†–µ–∂–∏–º | Tool calls | Trace | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|-------|-----------|-------|---------------|
| `enforce` | –†–µ–∞–ª—å–Ω–æ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è | –î–∞ | Production |
| `monitor` | –ü—Ä–æ—Ö–æ–¥—è—Ç –≤—Å–µ, –≤–µ—Ä–¥–∏–∫—Ç—ã —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è | –î–∞ | –ù–∞–±–ª—é–¥–µ–Ω–∏–µ –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Ä–∞–±–æ—Ç—É –∞–≥–µ–Ω—Ç–∞ |
| `dry-run` | –ü—Ä–æ—Ö–æ–¥—è—Ç –≤—Å–µ, –≤–µ—Ä–¥–∏–∫—Ç—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è | –î–∞ | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª –ø–µ—Ä–µ–¥ enforce |

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π workflow: `dry-run` ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å trace ‚Üí `monitor` ‚Üí —É–±–µ–¥–∏—Ç—å—Å—è ‚Üí `enforce`.

---

## 11. CLI-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### 11.1 –ö–æ–º–∞–Ω–¥—ã

```
policyshield validate <rules_path>
  –í–∞–ª–∏–¥–∞—Ü–∏—è YAML-—Ñ–∞–π–ª–æ–≤: —Å–∏–Ω—Ç–∞–∫—Å–∏—Å, —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å ID, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å regex,
  —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã priority.

policyshield lint <rules_path>
  –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏: –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞, —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
  (–Ω–∞–ø—Ä–∏–º–µ—Ä, tool: "*" —Å then: allow), –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è –ø—Ä–∞–≤–∏–ª–∞,
  –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑ message/suggestion.

policyshield test <rules_path> --scenario <file>
  –ü—Ä–æ–≥–æ–Ω —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (YAML-—Ñ–∞–π–ª—ã —Å mock tool calls)
  –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–∂–∏–¥–∞–µ–º—ã—Ö –≤–µ—Ä–¥–∏–∫—Ç–æ–≤.

policyshield trace show|stats|violations|export
  –†–∞–±–æ—Ç–∞ —Å –∞—É–¥–∏—Ç–Ω—ã–º –ª–æ–≥–æ–º (–æ–ø–∏—Å–∞–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ 9.4).

policyshield init
  –°–æ–∑–¥–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –ø—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.
```

### 11.2 –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

–§–∞–π–ª —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑ –∑–∞–ø—É—Å–∫–∞ –∞–≥–µ–Ω—Ç–∞:

```
# test_scenarios.yaml
scenarios:
  - name: "Block rm -rf"
    tool: exec
    args: { command: "rm -rf /" }
    expect:
      verdict: block
      rule_id: no-destructive-shell

  - name: "Allow ls in workspace"
    tool: exec
    args: { command: "ls -la {{workspace}}" }
    expect:
      verdict: allow

  - name: "Block PII in web_fetch"
    tool: web_fetch
    args: { url: "https://api.example.com?email=test@corp.com" }
    expect:
      verdict: block
      rule_id: no-pii-external
      pii_detected: [PII_DIRECT]
```

---

## 12. –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å

### 12.1 Custom Matchers

–ü–æ–º–∏–º–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π (`regex`, `contains`, `starts_with` –∏ —Ç.–¥.), —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–∂–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ matcher-—Ñ—É–Ω–∫—Ü–∏–∏:

```
# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: shield_engine.register_matcher("is_internal_url", fn)
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ YAML:
args_match:
  url: { custom: "is_internal_url" }
```

### 12.2 Custom Verdict Handlers

–ü–æ–º–∏–º–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –≤–µ—Ä–¥–∏–∫—Ç–æ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:
- `log_and_alert` ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç—å, –Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å alert –≤ Slack/PagerDuty
- `throttle` ‚Äî –∑–∞–º–µ–¥–ª–∏—Ç—å (–¥–æ–±–∞–≤–∏—Ç—å sleep) –≤–º–µ—Å—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- `transform` ‚Äî —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º

### 12.3 Plugin Architecture

PolicyShield –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–ª–∞–≥–∏–Ω—ã –¥–ª—è:
- **PII Detectors** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ L1 (NER) –∏–ª–∏ L2 (LLM) –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–≤
- **Trace Backends** ‚Äî –∑–∞–ø–∏—Å—å trace –≤ SQLite, PostgreSQL, S3
- **Integration Adapters** ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –¥—Ä—É–≥–∏–º –∞–≥–µ–Ω—Ç–Ω—ã–º —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞–º
- **Notification Channels** ‚Äî Slack, PagerDuty, email –¥–ª—è approval/alert

---

## 13. –ú–µ—Ç—Ä–∏–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —á–µ—Ä–µ–∑ OpenTelemetry)

| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `policyshield.check.latency_ms` | –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å pre/post-call check |
| `policyshield.verdicts{decision}` | –°—á—ë—Ç—á–∏–∫ –ø–æ —Ç–∏–ø–∞–º –≤–µ—Ä–¥–∏–∫—Ç–æ–≤ |
| `policyshield.pii.detections{label}` | –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø–æ —Ç–∏–ø–∞–º PII |
| `policyshield.approvals.requested` | –ó–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ approval |
| `policyshield.approvals.granted` | –û–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö |
| `policyshield.approvals.timed_out` | –ü—Ä–æ—Ç—É—Ö—à–∏—Ö |
| `policyshield.repair_loops` | –ö–æ–ª-–≤–æ repair-loop –∏—Ç–µ—Ä–∞—Ü–∏–π (–∞–≥–µ–Ω—Ç –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª –ø–æ—Å–ª–µ BLOCK) |
| `policyshield.sessions.active` | –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π |

---

## 14. –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

| # | –í–æ–ø—Ä–æ—Å | –ö–æ–Ω—Ç–µ–∫—Å—Ç |
|---|--------|----------|
| 1 | –ù—É–∂–Ω–∞ –ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `DENY-by-default` (closed policy) –∏–∑ –∫–æ—Ä–æ–±–∫–∏, –∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ catch-all –ø—Ä–∞–≤–∏–ª–∞? | –í–ª–∏—è–µ—Ç –Ω–∞ UX –∏ –ø–µ—Ä–≤–æ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ |
| 2 | –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å SpawnTool? Subagent –Ω–∞—Å–ª–µ–¥—É–µ—Ç session/taints/rules? | –í nanobot subagents ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ AgentLoop |
| 3 | –§–æ—Ä–º–∞—Ç counterexample: plain text vs JSON? | LLM –ª—É—á—à–µ –ø–∞—Ä—Å—è—Ç plain text, –Ω–æ JSON –º–∞—à–∏–Ω–Ω–æ-—á–∏—Ç–∞–µ–º |
| 4 | –ù—É–∂–µ–Ω –ª–∏ Web UI / Dashboard, –∏–ª–∏ CLI –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ? | –î–ª—è enterprise Web UI –ø—Ä–∏–≤—ã—á–Ω–µ–µ, –Ω–æ —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç |
