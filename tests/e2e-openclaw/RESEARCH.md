# OpenClaw E2E Research

> Generated by prompt 73 recon. Date: 2026-02-15

## Docker Image

- **Public image:** ❌ Not on Docker Hub or GHCR
- **Dockerfile:** ✅ Exists in repo root
- **Base:** `node:22-bookworm` + Bun + pnpm
- **Build:** `pnpm install --frozen-lockfile && pnpm build && pnpm ui:build`
- **docker-compose.yml:** ✅ Exists. Services:
  - `openclaw-gateway` — binds port 18789 (WebSocket/HTTP), 18790 (bridge)
  - `openclaw-cli` — separate CLI service
  - Auth: `OPENCLAW_GATEWAY_TOKEN` env var
  - Config mount: `OPENCLAW_CONFIG_DIR:/home/node/.openclaw`
  - Workspace mount: `OPENCLAW_WORKSPACE_DIR:/home/node/.openclaw/workspace`

**Impact on E2E:** Must build image from source. No pre-built image to `docker pull`.

## API for Tool Calls

- **REST API:** ❌ **No REST endpoint for tool calls**
- **Architecture:** Gateway is a **WebSocket server** on port 18789
  - Clients connect via WS and send messages through channels
  - Tool calls happen inside agent sessions, not via HTTP endpoint
- **Health endpoint:** Not found as standalone — health is managed via `health-state.ts`
- **Auth:** `OPENCLAW_GATEWAY_TOKEN` for gateway access

**Impact on E2E:** Cannot call `POST /api/tool-call`. Must either:
1. Send messages via a channel (WS) and observe tool execution + plugin hooks
2. Use programmatic testing (import hook runner + plugin directly, no gateway)
3. Build a test harness that simulates OpenClaw's plugin loading

## Plugin Loading

### Discovery paths (in order):

1. `plugins.load.paths` from `openclaw.yaml` config (origin: `config`)
2. `workspace/.openclaw/extensions/` (origin: `workspace`)
3. `~/.openclaw/extensions/` (origin: `global`) — resolves to `$OPENCLAW_CONFIG_DIR/extensions/`
4. Bundled plugins dir (origin: `bundled`)

### Supported file types:
`.ts`, `.js`, `.mts`, `.cts`, `.mjs`, `.cjs` (not `.d.ts`)

### Config format in `openclaw.yaml`:

```yaml
plugins:
  enabled: true
  load:
    paths:
      - /path/to/my/plugin.ts
      - /path/to/plugin-package/
  entries:
    my-plugin:
      enabled: true
      config:
        # plugin-specific config
  allow:
    - my-plugin
  deny:
    - other-plugin
```

### Volume mount for Docker:
Mount plugin directory to `$OPENCLAW_CONFIG_DIR/extensions/` inside container,
or add path to `plugins.load.paths` in config.

**Impact on E2E:** Can mount our plugin via Docker volume → `extensions/` dir.

## Test Mode (no LLM)

- **`SKIP_LLM` / `TEST_MODE`:** ❌ Not found
- **Mock provider:** Not found in main codebase
- **`applyTestPluginDefaults`:** Exists in `config-state.ts` but is for plugin
  config defaults during testing, not for skipping LLM
- **Vitest:** Project uses vitest internal tests but these test individual components,
  not full agent sessions

**Impact on E2E:** No way to run a full agent cycle without an LLM API key.
This means E2E tests that involve actual tool calls require:
1. An LLM API key (cost + flakiness), OR
2. A test harness that directly loads the plugin and simulates hook dispatch
   (the approach our `openclaw-compat.test.ts` already takes)

## Plugin SDK Exports

From prompt 71 recon:

- **`openclaw/plugin-sdk` barrel exports:** ~100 types, BUT:
  - ✅ `OpenClawPluginApi`, `OpenClawPluginService`, `RuntimeLogger`
  - ❌ `OpenClawPluginDefinition`, `PluginHook*` types, `PluginLogger`
- Hook types exist in internal files (`plugins/types.ts`, `plugins/hooks.ts`)
  but are NOT re-exported through the public barrel
- Official extensions (e.g. Twitch) import **channel** types from
  `openclaw/plugin-sdk`, not hook types — hooks are dispatched by the
  runtime, plugins implement `OpenClawPluginDefinition` (which is also internal!)

## Key Conclusions

1. **E2E with real OpenClaw is very expensive:**
   - No public Docker image → must build from source (~5min build)
   - No REST API for tool calls → must use WebSocket or mock
   - No test mode → requires real LLM API key
   - High flakiness risk (LLM responses are non-deterministic)

2. **Our current approach (`openclaw-compat.test.ts`) is actually well-suited:**
   - It simulates OpenClaw's plugin loading and hook dispatch
   - Tests run in ~1s without any external dependencies
   - Covers the real integration surface (hooks, config, error handling)

3. **Recommended E2E strategy:**
   - **Tier 1 (keep):** `openclaw-compat.test.ts` — programmatic hook dispatch tests
   - **Tier 2 (add):** Smoke test that imports real `openclaw` loader and verifies
     our plugin loads without errors (already partially done with SDK install)
   - **Tier 3 (future, manual):** Full Docker Compose with LLM key for release validation
