# üî• Tier 1.5 ‚Äî Security & Data Protection

–ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–∫–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –≤—Å–µ –∫–∞–Ω–∞–ª—ã: HTTP responses, –ª–æ–≥–∏, —Ñ–∞–π–ª—ã, auth.

### Secret/Credential Detection üî¥

–ï—Å—Ç—å PII-–¥–µ—Ç–µ–∫—Ç–æ—Ä (email, SSN, IBAN‚Ä¶), –Ω–æ –Ω–µ—Ç –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ **—Å–µ–∫—Ä–µ—Ç–æ–≤**. –ê–≥–µ–Ω—Ç —Å–ª—É—á–∞–π–Ω–æ –ø–µ—Ä–µ–¥–∞—ë—Ç API key, JWT, AWS access key, private key –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö ‚Äî –∏ –æ–Ω–∏ —É—Ç–µ–∫–∞—é—Ç.

```yaml
sanitizer:
  secret_detection:
    enabled: true
    patterns: [aws_key, jwt, private_key, api_key, github_token]
    action: BLOCK
```

- **–£—Å–∏–ª–∏—è**: –ú–∞–ª–µ–Ω—å–∫–∏–µ (~80 —Å—Ç—Ä–æ–∫, regex-–ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å PII)
- **–¶–µ–Ω–Ω–æ—Å—Ç—å**: üî•üî•üî• ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É—Ç–µ—á–µ–∫, PII –µ—ë –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç

### Admin Token Separation (Read vs Write Auth) üî¥

`/api/v1/reload`, `/api/v1/kill`, `/api/v1/respond-approval` –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–æ—Ç –∂–µ `POLICYSHIELD_API_TOKEN` —á—Ç–æ –∏ `/api/v1/check`. –õ—é–±–æ–π –∫–ª–∏–µ–Ω—Ç —Å —Ç–æ–∫–µ–Ω–æ–º –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞, –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å kill switch, –æ–¥–æ–±—Ä—è—Ç—å approvals. –î–ª—è production –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º –¥–≤–∞ —É—Ä–æ–≤–Ω—è:

```bash
# Read-only (–¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤): check, post-check, constraints, health
POLICYSHIELD_API_TOKEN=agent-token-xxx

# Admin (–¥–ª—è ops): reload, kill, resume, respond-approval
POLICYSHIELD_ADMIN_TOKEN=admin-token-yyy
```

- **–£—Å–∏–ª–∏—è**: –ú–∞–ª–µ–Ω—å–∫–∏–µ (~30 —Å—Ç—Ä–æ–∫, –≤—Ç–æ—Ä–æ–π Depends –¥–ª—è admin endpoints)
- **–¶–µ–Ω–Ω–æ—Å—Ç—å**: üî•üî•üî• ‚Äî –ø—Ä–∏–Ω—Ü–∏–ø –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π, –∏–Ω–∞—á–µ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞ = –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å

### Sensitive Data –≤ Error Responses üî¥

–ü—Ä–∏ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–∏ FastAPI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π `500` —Å Python stack traces, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
- –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (`/app/policyshield/shield/pii.py:42`)
- —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `args` (PII, —Å–µ–∫—Ä–µ—Ç—ã, API –∫–ª—é—á–∏)
- –∏–º–µ–Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –º–æ–¥—É–ª–µ–π –∏ –≤–µ—Ä—Å–∏–∏

**–ù–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç—Å—è** HTTP Error Handler (–∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ verdict –ø—Ä–∏ –æ—à–∏–±–∫–µ). –≠—Ç–æ –ø—Ä–æ **—É—Ç–µ—á–∫—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏** —á–µ—Ä–µ–∑ error responses.

```python
# –°–µ–π—á–∞—Å –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏:
# {"detail": "File /app/policyshield/shield/matcher.py, line 87..."}
#
# –ù—É–∂–Ω–æ: generic error –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π –≤ production
# {"error": "internal_error", "message": "Check failed"}
```

- **–£—Å–∏–ª–∏—è**: –ú–∞–ª–µ–Ω—å–∫–∏–µ (~20 —Å—Ç—Ä–æ–∫, –≥–ª–æ–±–∞–ª—å–Ω—ã–π exception handler + `debug` flag –≤ –∫–æ–Ω—Ñ–∏–≥–µ)
- **–¶–µ–Ω–Ω–æ—Å—Ç—å**: üî•üî•üî• ‚Äî —É—Ç–µ—á–∫–∞ stack traces = —É—Ç–µ—á–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, information disclosure vulnerability

### Logging Sensitive Data (Log Sanitization) üî¥

`base_engine.py` –ø—Ä–∏ –æ—à–∏–±–∫–µ –º–∞—Ç—á–µ—Ä–∞: `logger.error("Matcher error: %s", e)` ‚Äî –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (PII, —Å–µ–∫—Ä–µ—Ç—ã). –®–∏—Ä–µ: **–Ω–µ—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ —á—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å**. `logger.info`, `logger.warning` –≤ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö –º–æ–≥—É—Ç —Å–ª—É—á–∞–π–Ω–æ —Å–ª–∏—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –ª–æ–≥–∏.

**–ù–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç—Å—è** "Sensitive Data –≤ Error Responses" (—Ç–∞ –ø—Ä–æ HTTP –æ—Ç–≤–µ—Ç—ã). –≠—Ç–æ –ø—Ä–æ **—Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –ª–æ–≥–∏** ‚Äî –¥—Ä—É–≥–æ–π –∫–∞–Ω–∞–ª —É—Ç–µ—á–∫–∏. –ï—Å–ª–∏ –≤–∫–ª—é—á–∏—Ç—å JSON logging (–∏–∑ roadmap) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ ELK/Datadog ‚Äî args —É—Ç–µ–∫—É—Ç –≤ –ª–æ–≥-—Å–∏—Å—Ç–µ–º—É.

```python
# –°–µ–π—á–∞—Å: exception –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å args —Å PII/—Å–µ–∫—Ä–µ—Ç–∞–º–∏
logger.error("Matcher error: %s", e)
# e.args –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å: {"ssn": "123-45-6789", "api_key": "sk-xxx..."}

# –ù—É–∂–Ω–æ: log filter/sanitizer
class SensitiveDataFilter(logging.Filter):
    def filter(self, record):
        record.msg = sanitize_log_message(record.msg)
        return True
```

- **–£—Å–∏–ª–∏—è**: –ú–∞–ª–µ–Ω—å–∫–∏–µ (~30 —Å—Ç—Ä–æ–∫, logging.Filter + sanitize —Ñ—É–Ω–∫—Ü–∏—è)
- **–¶–µ–Ω–Ω–æ—Å—Ç—å**: üî•üî•üî• ‚Äî –±–µ–∑ —ç—Ç–æ–≥–æ PII/—Å–µ–∫—Ä–µ—Ç—ã —É—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ –ª–æ–≥–∏ –≤ –ª–æ–≥-–∞–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã

### Trace File Permissions üî¥ `v1.0-blocker`

`TraceRecorder` —Å–æ–∑–¥–∞—ë—Ç JSONL —Ñ–∞–π–ª—ã —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ permissions –û–° (–æ–±—ã—á–Ω–æ `644`/`rw-r--r--`). –¢—Ä–µ–π—Å—ã —Å–æ–¥–µ—Ä–∂–∞—Ç `args` (–≤–∫–ª—é—á–∞—è PII, –µ—Å–ª–∏ `privacy_mode` off). –õ—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å audit log. –î–ª—è compliance (SOC 2, GDPR) audit trail –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `600`/`rw-------`.

```python
# –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞ —Ç—Ä–µ–π—Å–æ–≤:
fd = os.open(trace_path, os.O_WRONLY | os.O_CREAT | os.O_APPEND, 0o600)
# –∏–ª–∏ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è:
os.chmod(trace_path, 0o600)  # owner-only read/write
```

- **–£—Å–∏–ª–∏—è**: 1 —Å—Ç—Ä–æ–∫–∞
- **–¶–µ–Ω–Ω–æ—Å—Ç—å**: üî•üî•üî• ‚Äî PII –≤ —á–∏—Ç–∞–µ–º—ã—Ö —Ñ–∞–π–ª–∞—Ö = data leak –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é

### Admin Rate Limit / Auth Brute-Force Protection üî¥

–ù–µ—Ç rate limit –Ω–∞ admin endpoints (`/kill`, `/reload`, `/respond-approval`) –∏ –Ω–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç brute-force –ø–æ–¥–±–æ—Ä–∞ `POLICYSHIELD_API_TOKEN`. –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ auth –ø–æ–ø—ã—Ç–æ–∫ –≤ —Å–µ–∫—É–Ω–¥—É. –°–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç —Å —Ç–æ–∫–µ–Ω–æ–º –º–æ–∂–µ—Ç —Å–ø–∞–º–∏—Ç—å `/reload` 1000 —Ä–∞–∑/—Å–µ–∫.

–û—Ç–¥–µ–ª—å–Ω–æ –æ—Ç ¬´Rate Limit –Ω–∞ HTTP API¬ª (Tier 2) ‚Äî —Ç—É—Ç —Ñ–æ–∫—É—Å –Ω–∞ **admin-–æ–ø–µ—Ä–∞—Ü–∏—è—Ö –∏ auth**, –∞ –Ω–µ –Ω–∞ `/check`.

```yaml
server:
  admin_rate_limit: 10/min    # –º–∞–∫—Å 10 admin-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
  auth_fail_limit: 5/min      # –º–∞–∫—Å 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö auth –ø–æ–ø—ã—Ç–æ–∫ ‚Üí 429
  auth_fail_lockout: 300s     # lockout –ø–æ—Å–ª–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è
```

- **–£—Å–∏–ª–∏—è**: –ú–∞–ª–µ–Ω—å–∫–∏–µ (~30 —Å—Ç—Ä–æ–∫, counter + middleware)
- **–¶–µ–Ω–Ω–æ—Å—Ç—å**: üî•üî•üî• ‚Äî –±–µ–∑ —ç—Ç–æ–≥–æ brute-force —Ç–æ–∫–µ–Ω–∞ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω, admin abuse –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è
